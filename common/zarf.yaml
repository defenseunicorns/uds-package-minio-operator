# yaml-language-server: $schema=https://raw.githubusercontent.com/defenseunicorns/zarf/v0.33.1/zarf.schema.json
kind: ZarfPackageConfig

metadata:
  name: minio-operator
  description: UDS Minio Operator and Tenant Package`

components:
  - name: minio-operator
    charts:
      - name: uds-minio-config
        namespace: minio-operator
        version: 0.1.0
        localPath: ../chart
        variables:
          - name: TENANT
            path: minio.displayName
            description: The name of the tenant
      - name: minio-operator
        version: v5.0.15
        url: https://github.com/minio/operator.git
        gitPath: helm/operator
        namespace: minio-operator
        valuesFiles:
          - ../values/common-values.yaml
      - name: minio-tenant
        version: v5.0.15
        url: https://github.com/minio/operator.git
        gitPath: helm/tenant/
        namespace: minio
        valuesFiles:
          - ../values/tenant-values.yaml
        variables:
          - name: TENANT
            path: tenant.name
            description: The name of the tenant
          - name: POOLS
            path: tenant.pools
            description: Define the pools for the tenant
    actions:
      onDeploy:
        after:
          - description: Validate Minio Operator Package
            maxTotalSeconds: 300
            wait:
              cluster:
                kind: Packages
                name: minio-operator
                namespace: minio-operator
                condition: "'{.status.phase}'=Ready"
          - description: Validate Minio Tenant Package
            maxTotalSeconds: 300
            wait:
              cluster:
                kind: Packages
                name: minio
                namespace: minio
                condition: "'{.status.phase}'=Ready"
          # This check works but seems to take a lot longer than it takes for the tenant to actually be available for use      
          # - description: Validate Minio Tenant CR
          #   maxTotalSeconds: 300
          #   wait:
          #     cluster:
          #       kind: Tenant
          #       name: ${ZARF_VAR_TENANT}
          #       namespace: minio
          #       condition: "'{.status.healthStatus}'=green"
          - description: Minio App/Tenant Status
            wait:
              cluster:
                kind: pod
                name: app=minio
                namespace: minio
                condition: Ready
          - description: Wait for console to be available
            maxTotalSeconds: 15
            wait:
              # wait for a network address to return a 200 OK response
              network:
                protocol: https
                address: minio-console.${ZARF_VAR_DOMAIN}
                code: 200
          - description: Wait for the operator console to be available
            maxTotalSeconds: 15
            wait:
              # wait for a network address to return a 200 OK response
              network:
                protocol: https
                address: minio-operator-console.admin.${ZARF_VAR_DOMAIN}
                code: 200                
